# Makefile for lbcd
# $Id$

# Eventually, this should come from Autoconf.
VERSION= 3.1.2

CC     = @CC@

DEFS   = @DEFS@
LIBS   = @LIBS@
CFLAGS = @CFLAGS@

srcdir = @srcdir@
VPATH  = @srcdir@

SHELL  = /bin/sh

prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
sbindir		= @sbindir@

INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
INSTALL_SCRIPT	= @INSTALL_SCRIPT@

HDRS   = config.h lbcd.h lbcdload.h protocol.h

SRCS   = lbcd.c server.c util.c \
	kernel.c get_user.c tmp_full.c weight.c load.c

OBJS   = $(SRCS:.c=.o)
LIBRARY= modules/liblbcd.a

all: lbcd

.c.o: $(HDRS) $*.c
	$(CC) -c -I. -I$(srcdir) $(DEFS) $(CFLAGS) $<

lbcd: $(OBJS) $(LIBRARY)
	$(CC) $(LDFLAGS) -o $@ $(OBJS) $(LIBRARY) $(LIBS)

$(LIBRARY):
	cd modules && ${MAKE}

install: lbcd
	$(INSTALL) -d $(bindir) $(sbindir)
	$(INSTALL_PROGRAM) lbcd $(sbindir)/lbcd
	$(INSTALL_SCRIPT) $(srcdir)/lbcdclient $(bindir)/lbcdclient

clean:
	-rm -f *.o core lbcd
	cd modules && ${MAKE} $@

distclean: clean
	-rm -f Makefile config.log config.status config.cache config.h
	cd modules && ${MAKE} $@

dist:
	mkdir lbcd-$(VERSION)
	cp COPYRIGHT LAYOUT Makefile.in NEWS TODO acconfig.h config.h.in \
	    configure configure.in get_user.c install-sh kernel.c lbcd.c \
	    lbcd.h lbcdclient lbcdload.h load.c protocol.h server.c \
	    tmp_full.c util.c version.h weight.c lbcd-$(VERSION)/
	mkdir lbcd-$(VERSION)/arch
	cp arch/*.c lbcd-$(VERSION)/arch/
	mkdir lbcd-$(VERSION)/modules
	cp modules/*.in modules/*.c modules/*.h lbcd-$(VERSION)/modules/
	tar cf lbcd-$(VERSION).tar lbcd-$(VERSION)
	gzip -9 lbcd-$(VERSION).tar
	rm -rf lbcd-$(VERSION)

# Dependencies.
kernel.o: $(srcdir)/kernel.c \
	$(srcdir)/arch/aix.c $(srcdir)/arch/hpux10.c \
	$(srcdir)/arch/irix.c $(srcdir)/arch/linux.c \
	$(srcdir)/arch/osf.c $(srcdir)/arch/solaris.c
