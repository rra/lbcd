.\" Automatically generated by Pod::Man 2.25 (Pod::Simple 3.22)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.ie \nF \{\
.    de IX
.    tm Index:\\$1\t\\n%\t"\\$2"
..
.    nr % 0
.    rr F
.\}
.el \{\
.    de IX
..
.\}
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "LBCD 8"
.TH LBCD 8 "2012-09-20" "3.4.0" "lbcd"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
lbcd \- Report system load for remote load balancing
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
lbcd [\fB\-dhlRrt\fR] [\fB\-b\fR \fIaddress\fR] [\fB\-c\fR \fIcommand\fR] [\fB\-P\fR \fIfile\fR]
[\fB\-p\fR \fIport\fR] [\fB\-T\fR\ \fIseconds\fR] [\fB\-w\fR \fIweight\fR]
.PP
lbcd \fB\-s\fR [\fB\-P\fR \fIfile\fR]
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
\&\fBlbcd\fR runs as a daemon and reports various system utilization
information and optionally service status information via a \s-1UDP\s0 network
protocol.  It is designed to run on the client systems of a remote load
balancing system, such as the DNS-based \fBlbnamed\fR load balancer.
.PP
\&\fBlbcd\fR supports two different query protocols, version two and version
three.  (Currently, \fBlbnamed\fR only supports version two queries.)  Either
will return the current time according to that system, the time of the
last system boot, the time the information about logged in users last
changed, the load averages (one, five, and fifteen minute), the total and
unique logged in users, whether a user is logged in on console, percentage
full of the system \fI/tmp\fR directory is full, and percentage full of the
system \fI/var/tmp\fR directory.  (See, however, the note below about how
some of this data is replaced with calculated weights for version two
responses.)  The version three protocol can also return weight and
increment information about a set of services.
.PP
The service information is based around a model that returns a weight
(indicating the current utilization of the box \*(-- the higher, the busier)
and an increment (an estimate of how much the utilization will increase
for each additional connection directed to this box) which defaults to
one.  The intent is for the load balancer to query the system
periodically, using the returned weight as the system load, and to
estimate the system load between queries of \fBlbcd\fR as the last returned
weight plus the last returned increment times the number of connections
directed to that system.  By default, only one service is returned.  That
service weight is calculated as follows:
.PP
.Vb 2
\&    (<uniq\-users> * 100 + 300 * <one\-minute\-load>
\&        + (<total\-users> \- <unique\-users>) * 20) * <tmp\-penalty>
.Ve
.PP
where <tmp\-penalty> is a multiplier applied for the most full of \fI/tmp\fR
and \fI/var/tmp\fR.  <tmp\-penalty> will be 1 if both are less than 90% full
and will range between 2 for 90\-93% full up to 32 for 100% full.  If
\&\fI/tmp\fR or \fI/var/tmp\fR are completely full, the maximum possible weight
will be returned.
.PP
If you want to use a simple load average instead, pass the \fB\-S\fR option to
\&\fBlbcd\fR and then the load service will use only the one-minute load.
.PP
Since \fBlbnamed\fR calculates the weight from the one minute load and the
number of logged-in users and currently only supports version two, \fBlbcd\fR
will replace the one-minute load with the weight of the primary service
when responding to a version two query and will set all of the user
numbers to zero unless \fB\-S\fR was given.  If \fB\-S\fR was given, the values
returned will be left alone.  (This means that \fB\-S\fR will override \fB\-R\fR
for version two queries, since \fB\-R\fR is equivalent to specifying a service
of \f(CW\*(C`rr\*(C'\fR.)
.PP
\&\fBlbcd\fR responds to any \s-1UDP\s0 packets on port 4330 (or the port given with
the \fB\-p\fR option).  It has no built-in security, so if you do not want to
disclose the above information to random systems on the Internet, you will
want to limit access to this port using iptables, firewall rules, or other
similar measures.
.PP
By default, \fBlbcd\fR listens on all addresses and responds on whatever
address the kernel picks for outgoing packets.  \fBlbnamed\fR sends out all
of its packets and then waits for replies and uses the source address of
the reply packet to associate that reply with one of the queried hosts.
This means that if \fBlbnamed\fR is not configured to query the same address
as the kernel picks for \fBlbcd\fR to respond on, the response may be ignored
and the host considered down.  To work around this, use the \fB\-b\fR flag on
hosts with multiple interfaces to ensure that replies go out on the
interface being queried.  If a host has multiple \s-1IP\s0 addresses that will be
queried, run multiple instances of \fBlbcd\fR, one for each interface.
.SH "OPTIONS"
.IX Header "OPTIONS"
.IP "\fB\-b\fR \fIaddress\fR" 4
.IX Item "-b address"
By default, \fBlbcd\fR binds to all available addresses.  If this option is
given, \fBlbcd\fR binds only to the specified address and will only answer
\&\s-1UDP\s0 queries to that address.
.IP "\fB\-c\fR \fIcommand\fR" 4
.IX Item "-c command"
Obtain the service weight and increment by running an external command.
This command should print to standard output one line containing two
integer numbers, separated by whitespace.  The first number is taken to be
the weight and the second number is taken to be the increment.  (As
mentioned above, when responding to version two protocol queries, the
weight is returned as the one-minute load average.)
.IP "\fB\-d\fR" 4
.IX Item "-d"
Don't run as a daemon (meaning don't fork and detach from a tty) to make
it easier to run \fBlbcd\fR inside a debugger.
.IP "\fB\-h\fR" 4
.IX Item "-h"
Print out usage information and exit.
.IP "\fB\-l\fR" 4
.IX Item "-l"
Currently does nothing.  Eventually this will tell lbcd to log all
received requests, but this has not yet been implemented.
.IP "\fB\-P\fR \fIfile\fR" 4
.IX Item "-P file"
Use \fIfile\fR to store the \s-1PID\s0 of the running \fBlbcd\fR process and as the
file to read for the \fB\-r\fR and \fB\-s\fR options, rather than the default of
\&\fI/var/run/lbcd.pid\fR.
.IP "\fB\-p\fR \fIport\fR" 4
.IX Item "-p port"
Listen on \fIport\fR rather than the default of 4330.
.IP "\fB\-R\fR" 4
.IX Item "-R"
Use round-robin as the service.  This will always return a weight of one
and an increment of one.  It is equivalent to \f(CW\*(C`\-w rr\*(C'\fR.  For version two
responses, it will always return a one-minute load of one regardless of
the actual load average of the system (unless \fB\-S\fR is used).
.IP "\fB\-r\fR" 4
.IX Item "-r"
Restart a running \fBlbcd\fR process.  This stops the existing \fBlbcd\fR
process by killing the \s-1PID\s0 named in \fI/var/run/lbcd.pid\fR or the file given
with the \fB\-P\fR option and then starts as the new \fBlbcd\fR process.
.IP "\fB\-S\fR" 4
.IX Item "-S"
When answering version two queries, do not attempt to adjust for
\&\fBlbnamed\fR's logic and force it to use the service weight.  Instead,
report the load averages and number of logged in users accurately.  This
means that version two responses will not contain any information derived
from custom services or weight settings and the \fB\-c\fR, \fB\-w\fR, and \fB\-R\fR
options will be ignored for version two responses.
.IP "\fB\-s\fR" 4
.IX Item "-s"
Stop an existing \fBlbcd\fR process by killing the \s-1PID\s0 named in
\&\fI/var/run/lbcd.pid\fR or the file given with the \fB\-P\fR option.
.IP "\fB\-T\fR \fIseconds\fR" 4
.IX Item "-T seconds"
Use a timeout of \fIseconds\fR when doing service probes (including running a
command with \fB\-c\fR).  The default is five seconds.
.IP "\fB\-w\fR \fIweight\fR" 4
.IX Item "-w weight"
Specify either a service to probe or a weight and increment to always
return.  \fIweight\fR can be a string of the form \fIweight\fR:\fIincrement\fR
where both \fIweight\fR and \fIincrement\fR are numbers, in which case that
weight and increment will always be returned.  Alternately, it can be the
name of a service module, in which case that service will be probed and
its weight will be returned as the service weight (and the one-minute load
with version two queries).
.Sp
The currently supported services are \f(CW\*(C`load\*(C'\fR (the default), \f(CW\*(C`ftp\*(C'\fR,
\&\f(CW\*(C`http\*(C'\fR, \f(CW\*(C`imap\*(C'\fR, \f(CW\*(C`nntp\*(C'\fR, \f(CW\*(C`ntp\*(C'\fR, \f(CW\*(C`pop\*(C'\fR, \f(CW\*(C`smtp\*(C'\fR, \f(CW\*(C`tcp\*(C'\fR, and \f(CW\*(C`rr\*(C'\fR
(round-robin, the same as \fB\-R\fR).  The \f(CW\*(C`http\*(C'\fR and \f(CW\*(C`tcp\*(C'\fR services must be
followed by a colon and a port number.
.SH "FILES"
.IX Header "FILES"
.IP "\fI/var/run/lbcd.pid\fR" 4
.IX Item "/var/run/lbcd.pid"
The default location of the \s-1PID\s0 file.  \fBlbcd\fR puts its \s-1PID\s0 in this file
when it starts, and refers to this file for the \fB\-r\fR and \fB\-s\fR commands.
The file location can be changed with \fB\-P\fR.
.SH "SEE ALSO"
.IX Header "SEE ALSO"
\&\fIlbcdclient\fR\|(1)
.PP
The current version of this program is available from its web page at
<http://www.eyrie.org/~eagle/software/lbcd/>.
.SH "AUTHORS"
.IX Header "AUTHORS"
Originally written by Roland Schemers and Larry Schwimmer.  Currently
maintained by Russ Allbery <rra@stanford.edu>.
.SH "COPYRIGHT AND LICENSE"
.IX Header "COPYRIGHT AND LICENSE"
Copyright 1993, 1994, 1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006,
2009, 2012 The Board of Trustees of the Leland Stanford Junior University
.PP
Copying and distribution of this file, with or without modification, are
permitted in any medium without royalty provided the copyright notice and
this notice are preserved.  This file is offered as-is, without any
warranty.
